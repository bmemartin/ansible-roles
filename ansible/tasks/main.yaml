---

- name: Ensure required packages are installed
  ansible.builtin.apt:
    name:
      - python3
      - python3-pip
      - pipx
    state: present
    update_cache: '{{ apt_update_cache }}'
    cache_valid_time: '{{ apt_cache_valid_time }}'
  tags: ansible

- name: Ensure pipx user path is configured
  ansible.builtin.command:
    cmd: pipx ensurepath
  become_user: '{{ pipx_user }}'
  register: _pipx_ensurepath_result
  failed_when: _pipx_ensurepath_result.rc != 0 or 'not added' in _pipx_ensurepath_result.stdout
  changed_when: "'success' in (_pipx_ensurepath_result.stdout | lower)"
  tags: ansible

- name: Install Ansible via pipx
  community.general.pipx:
    name: ansible
    state: "{{ 'latest' if pipx_update_latest else 'present' }}"
    install_deps: '{{ pipx_install_deps }}'
    include_injected: '{{ pipx_include_injected }}'
  become_user: '{{ pipx_user }}'
  tags:
    - ansible
    - update
